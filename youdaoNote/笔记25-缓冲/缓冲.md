

- 为什么要用缓冲
- 该用什么缓冲
- 用缓冲之后影响
- 


#### 缓冲分类
- 操作系统缓冲 
> 例如cpu和内存之间有高速缓冲
- 硬件缓冲  页表记录虚拟地址和物理地址映射，内存管理单元MMU负责映射，会有缓冲。
- 客户端缓冲
- 服务端缓冲
- 网络缓冲
- 
缓冲存储当时
- 单体缓冲
- 缓冲集群
- 分布式缓冲
- 

#### 客户端缓冲

- 页面缓冲 h5离线缓冲
- 浏览器缓冲 缓冲时间
- app缓冲  


#### 网络缓冲

- web代理缓冲squid,
- cdn缓冲


#### 服务端缓冲

- 数据库缓冲


#### 堆缓冲 堆外缓冲

https://mp.weixin.qq.com/s/CWWy1zx8yuWYDjRQ3Cywew


#### 缓冲算法

- 缓冲命中
- 缓冲未命中
- 缓冲失效
- 缓冲淘汰策略
> 缓冲淘汰策略 主要看使用频率，获取成本，缓冲容量和时间


#### 缓冲问题


- 缓冲击穿
- 缓冲并发
- 缓冲雪崩
- 缓冲同步 数据一致


> 缓冲击穿：恶意攻击或者设计失误。 大量不存在的key并发访问。
解决办法：1 设置key的缓冲值为空返回。2 验证key是否有效。

> 缓冲并发： 一个缓冲key过期，大量并发请求发现key过期之后 请求数据库更新key。
解决办法：1.加分布式锁 2.过期之前另一个线程及时更新key。软过期指对缓存中的数据设置失效时间，就是不使用缓存服务提供的过期时间，而是业务层在数据中存储过期时间信息，由业务程序判断是否过期并更新，在发现了数据即将过期时，将缓存的时效延长，程序可以派遣一个线程去数据库中获取最新的数据，其他线程这时看到延长了的过期时间，就会继续使用旧数据，等派遣的线程获取最新数据后再更新缓存。也可以通过异步更新服务来更新设置软过期的缓存，这样应用层就不用关心缓存并发的问题了

> 缓冲雪崩  大量key突然失效。  解决办法： key过期时间 或者 失效时间不要设置统一时间，可以随机设置。

> 缓冲同步 两个不同服务更新数据过程中很常见的情况，见下图，CRM系统更新了某个用户的Profile,保存更新数据库后，通过MQ通知用户系统更新缓存，由于是异步更新延迟，在缓存更新前，用户系统收到前端的指令，读取了当前缓存里的用户数据，做了修改，并更新到DB中。出现的结果就是数据库里的CRM的更新被错误覆盖。

解决办法

> 缓存里的数据有一个标志位可以作为更新数据库数据的依据（Update_time or Version）, 如果缓存里数据时间与数据库时间不能匹配，意味着另外一个服务更新了该数据，那么就先从DB里读取最新数据版本，然后在新版本上提交数据。


#### 缓冲区溢出

> 向缓冲区内填充数据时超过了缓冲区本身的容量，而导致数据溢出到被分配空间之外的内存空间，使得溢出的数据覆盖了其他内存空间的数据。